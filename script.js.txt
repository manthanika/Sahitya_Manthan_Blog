document.addEventListener("DOMContentLoaded", function () {
  // Like button
  document.querySelectorAll(".like-btn").forEach(button => {
    button.addEventListener("click", function () {
      const blogId = this.getAttribute("data-blog-id");
      sendToGoogleSheet("Likes", { blogId, action: "like" })
        .then(() => {
          const countSpan = this.querySelector(".like-count");
          countSpan.textContent = parseInt(countSpan.textContent) + 1;
        })
        .catch(error => console.error("Like error:", error));
    });
  });

  // Dislike button
  document.querySelectorAll(".dislike-btn").forEach(button => {
    button.addEventListener("click", function () {
      const blogId = this.getAttribute("data-blog-id");
      sendToGoogleSheet("Likes", { blogId, action: "dislike" })
        .then(() => {
          const countSpan = this.querySelector(".dislike-count");
          countSpan.textContent = parseInt(countSpan.textContent) + 1;
        })
        .catch(error => console.error("Dislike error:", error));
    });
  });

  // Comment toggle
  document.querySelectorAll(".comment-toggle").forEach(button => {
    button.addEventListener("click", function () {
      const commentSection = this.parentElement.querySelector(".comment-section");
      commentSection.style.display = commentSection.style.display === "none" ? "block" : "none";
    });
  });

  // Comment submit
  document.querySelectorAll(".comment-submit").forEach(button => {
    button.addEventListener("click", function () {
      const blogId = this.getAttribute("data-blog-id");
      const commentInput = this.parentElement.querySelector(".comment-input");
      const comment = commentInput.value.trim();
      if (comment) {
        sendToGoogleSheet("Comments", { blogId, comment })
          .then(() => {
            commentInput.value = "";
            alert("Comment submitted!");
          })
          .catch(error => console.error("Comment error:", error));
      }
    });
  });

  // Login form
  document.getElementById("loginForm")?.addEventListener("submit", function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = {
      email: formData.get("email"),
      password: formData.get("password"),
      sheetType: "Logins",
    };
    sendToGoogleSheet("Logins", data)
      .then(() => {
        document.getElementById("loginMessage").textContent = "Login recorded!";
      })
      .catch(error => console.error("Login error:", error));
  });

  // Google Sheets integration
  function sendToGoogleSheet(sheetType, data) {
    const scriptURL = "/api/submit"; // Use Netlify proxy
    const payload = { sheetType, ...data };
    console.log("Sending payload:", JSON.stringify(payload));

    return fetch(scriptURL, {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" },
      redirect: "follow",
    })
      .then(response => {
        console.log("Response status:", response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log("Success:", data);
        return data;
      })
      .catch(error => {
        console.error("Error sending to Google Sheet:", error);
        throw error;
      });
  }
});
